---
title: "WIP_code"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

standard library load
```{r}
library(readr)
library(dplyr)
library(tidyverse)
library(png)
library(raster)
library(rgdal)
library(ggplot2)
library(knitr)
library(leaflet)
library(maps)
library(lubridate)

library(RColorBrewer)

library(tiff)

library(plyr)
```


Actinotus forsythii data was downloaded from ALA
(this could also be turned into code that downlads straight from ala -although not particularly useful for non australian species)

```{r}
Actinotus_forsythii_alaobvs_28_10_21 <- read_csv("Actinotus_forsythii_alaobvs_28_10_21.csv")
View(Actinotus_forsythii_alaobvs_28_10_21)

Actinotus_forsythii <- dplyr::select(Actinotus_forsythii_alaobvs_28_10_21, raw_recordedBy, basisOfRecord, year, month, day, verbatimLocality, decimalLatitude, decimalLongitude)

Actinotus_forsythii <- dplyr::mutate(Actinotus_forsythii, id = row_number())

View(Actinotus_forsythii)
```



checking if lat long line up with what is expexted

```{r}

world <- map_data("world")

ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "white", fill = "lightgray", size = 0.1
    ) +
   theme_bw() +
  geom_point(
    data = Actinotus_forsythii,
    aes(decimalLongitude, decimalLatitude),
    alpha = 0.4, size = 0.1
    ) + scale_x_continuous(limits = c(140,155)) + scale_y_continuous(limits = c(-40,-30))

```


next...

Fire data needs to be attained

Fire data will be a grid where as lat, long of species data is a point. not sure if this will cause issues. 

Each location point has a date stamp. This date stap needs to be turned into a range and converted to the same format as the fire data date stamp. 

True/false for each data point if fire occours in the agreed date range. 

Percentage true false?



Using fire data from previous project (loaded into workspace from that project)
preliminalrily shows that graphically where we see fire, the following year we see A. forsythii now to try and test this.


```{r}
fire_2003_true <- subset(fire_2003, layer > 0)

Actinotus_forsythii_2003_burn <- subset(Actinotus_forsythii, year >2003 & year <2008)
```


```{r}
ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "black", fill = "white", size = 0.1
    ) +
   theme_bw() +
  geom_point(
    data = fire_2003_true,
    aes(x, y, colour=layer),
    alpha = 0.5, size = 1
    ) + scale_x_continuous(limits = c(147.5,152.5)) + scale_y_continuous(limits = c(-40,-32.5)) + 
  geom_point(
    data = Actinotus_forsythii_2003_burn,
    aes(decimalLongitude, decimalLatitude),
   alpha =0.5, size = 1
    ) + scale_x_continuous(limits = c(147.5,152.5)) + scale_y_continuous(limits = c(-40,-32.5))
```



firstly how do inflate fire data to be a range rather than a point?

```{r}

fire_2003_test <- fire_2003 


xrange <- function(fire_data) {
  fire_data %>%  mutate(xrange = x + 0.250) 
}
yrange <- function(fire_data) {
  fire_data %>% mutate(yrange = y - 0.250)
}
fire_true <- function(fire_data) {
  fire_data %>% mutate(fire_true = if_else (layer !=	0, TRUE, FALSE))
}


fire_2003_test <- xrange(fire_2003)
fire_2003_test <- yrange(fire_2003_test)
fire_2003_test <- fire_true(fire_2003_test)


str(fire_2003_test)

```

ok, now I need to crass reference. 
does point plant fit between x-xrange 


IGNORE THIS for a minute (code not runnin)
give me fire_true where (decimallat is >yrange and <y) and (decimallong >xrange and <x)

```{r}
fire_true <- (Actinotus_forsythii_2003_burn$decimalLongitude > fire_2003_test$yrange 
  & < fire_2003_test$y) &
  (Actinotus_forsythii_2003_burn$decimalLatitude > fire_2003_test$xrange 
  & < fire_2003_test$x)


get_true <-function()
  
  
fire_2003_test %<% left_join(Actinotus_forsythii_2003_burn, by = c())  

```



```{r}

burn_data <- function(path, species_df) {
   all_numbers<-str_extract(path, "(?<=A)[0-9]*")
   year<-substr(all_numbers, start = 1, stop = 4)
   julian_date<-substr(all_numbers, start = 5, stop = 7)

    fire_raster <- raster::stack(path)
  species_df$burn_data_julian_date <-
    raster::extract(fire_raster,
            cbind(species_df$decimalLongitude, species_df$decimalLatitude))
  species_df$fire_year <- year
  fire_date <- as.Date(paste0(year, "-01-01"))
  yday(fire_date) <- as.numeric(julian_date)
  species_df$fire_date <- fire_date
  species_df$fire_month <- month(fire_date)
  return(species_df)
}


list_of_files <- list.files("Win20", recursive =  TRUE, full.names = TRUE) %>% str_subset("burndate")

test<-burn_data(list_of_files[[1]],Actinotus_forsythii)

output<-lapply(list_of_files,burn_data,species_df=Actinotus_forsythii)
big_df<-bind_rows(output)

fire_only_records <- filter(big_df,burn_data_julian_date!=0 & year>=2000,year > fire_year)
fire_only_records$collection_date <- ymd(paste(fire_only_records$year,fire_only_records$month,fire_only_records$day,sep="-")) 
fire_only_records$date_differnce<-as.numeric(fire_only_records$collection_date-fire_only_records$fire_date)


fire_only_records %>% filter(date_differnce<600)->recent_fires

fire <- nrow(recent_fires)
total <- nrow(Actinotus_forsythii)
percentage_burnt <- (fire/total)*100







```






















```{r}
burn_data <- function(julian_date, year, species_df) {
  path <- paste0("Win20/2001/MCD64monthly.A2001", julian_date, ".Win20.006.burndate.tif")
  
## this bit of code is working if path year is specified
  fire_raster <- raster::stack(path)
  species_df$burn_data_julian_date <- raster::extract(fire_raster, cbind(species_df$decimalLongitude, species_df$decimalLatitude))
  species_df$fire_year <- year
  fire_date <- as.Date(paste0(year, "-01-01"))
  yday(fire_date) <- julian_date
  species_df$fire_month <- month(fire_date)
  
  
  return(species_df)
}




month_list_nonleep <- list(001, 032, 060, 091, 121, 152, 182, 213, 244, 274, 305, 335)
month_list_leep <- list(001, 032, 061, 092, 122, 153, 183, 214, 225, 274, 306, 336)
year_list_nonleep <- list(2001, 2002, 2003, 2005, 2006, 2007, 2009, 2010, 2011, 2013, 2014, 2015, 2017, 2018, 2019, 2021)
year_list_leep <- list(2000, 2004, 2008, 2012, 2016, 2020)



## tring to write a loop within a loop
fire_df <- function()
  
  
  
  month <- lapply(month_list_nonleep, burn_data, year, species_df)
  year <- lapply() 
   





# this works somehow
out <- lapply(month_list_nonleep, burn_data, year, species_df)
fire_df <- bind_rows(out)

```


```{r}
str(species_df)


##problem path isnt working when year is specified twice?

path<- paste0("Win20/2001/MCD64monthly.A2001001.Win20.006.burndate.tif")

path <- paste0("Win20/", year, "/MCD64monthly.A", year, julian_date, ".Win20.006.burndate.tif")



str(fire_raster)

plot(fire_raster)



 lat_long <- fire_raster %>% cbind(species_df$decimalLongitude, species_df$decimalLatitude)
  
  
  species_df$burn_data_julian_date <- extract(lat_long)
  
species_df <- Actinotus_forsythii
year <-2001
julian_date <- 001


species_df_2001_1 <- burn_data(001, 2001, Actinotus_forsythii)
species_df_2001_2 <- burn_data(032, 2001, Actinotus_forsythii)


spicies_df_all <- rbind(species_df_2001_1, species_df_2001_2)

spicies_df_all <- left_join(species_df_2001_1, species_df_2001_2, by = c("decimalLatitude", "decimalLongitude"))

```





```{r}
#not working -- for dealing with dates later on
fire_df <- raster::as.data.frame(fire_raster, xy = TRUE)
fire_df_ss <- subset(fire_df, fire_df[, 3] > 0)
fire_date <- as.Date(paste0(year, "-01-01"))
fire_df_ss$julian_date <- julian_date
fire_df_ss$day_of_month <- fire_df_ss[[3]] - fire_df_ss$julian_date +
  1
yday(fire_date) <- fire_df_ss[1, 3]
fire_df_ss$month <- month(fire_date)
fire_df_ss$year <- year
fire_df_ss$comb_date <-
  ymd(paste(
    fire_df_ss$year,
    fire_df_ss$month,
    fire_df_ss$day_of_month,
    sep = "-"
  ))

fire_df_ss %>%
  dplyr::select(x, y, comb_date) -> fss
fss <- data.frame(fss)
    

```


















this will clear your environment
```{r}
rm(list = ls())
```





